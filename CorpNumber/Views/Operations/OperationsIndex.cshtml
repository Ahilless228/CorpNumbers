@*
*@

@{
}

<!-- OperationsIndex.cshtml -->
@model IEnumerable<CorpNumber.Models.OperationViewModel>


<!-- Header -->
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="fw-bold fs-4 text-dark">Все операции</div>
        <div class="d-flex gap-2">
            <button type="button" id="changesPerMonth" class="btn btn-outline-primary">📑Изменения за месяц</button>
            <button type="button" id="changeOperationInfo" class="btn btn-outline-success">📐Изменить инфо операции</button>
        </div>
    </div>
</div>

<!-- Filters Row -->
<div class="mb-3 d-flex flex-wrap align-items-center gap-2">
    <input type="text" id="searchNumber" class="form-control" placeholder="Поиск по номеру" style="width: 200px;" />
    <input type="text" id="orderNumber" class="form-control" placeholder="Номер заявки" style="width: 150px;" />

    <select id="operationType" class="form-select" style="width: 180px;">
        <option value=''>Все операции</option>
        @foreach (var type in ViewBag.OperationTypes as List<string>)
        {
            <option value="@type">@type</option>
        }
    </select>
    <div>Период с</div>
    <input type="date" id="dateFrom" class="form-control" style="width: 180px;" />
    <div>по</div>
    <input type="date" id="dateTo" class="form-control" style="width: 180px;" />
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="filterComplete" />
        <label class="form-check-label" for="filterComplete">Выполненные</label>
    </div>

    <button id="resetFilters" class="btn btn-secondary">Сбросить</button>
</div>

<!-- Table Block -->
<div  id="operationTable">
    <!-- Таблица подгружается через AJAX -->
</div>


<!-- Pagination Block -->
<div id="paginationBlock" class="d-flex justify-content-between align-items-center mt-3 overflow-auto"></div>

<!--Мод окно инфо-->
@await Html.PartialAsync("_InfoModal")

@await Html.PartialAsync("_EditOperationModal")


<!-- Модальное окно выбора месяца -->
<div class="modal fade" id="monthModal" tabindex="-1" aria-labelledby="monthModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="monthModalLabel">Выбор месяца</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="yearSelect" class="form-label">Год</label>
          <select id="yearSelect" class="form-select">
            @{
                int currentYear = DateTime.Now.Year;
                for (int y = currentYear - 3; y <= currentYear + 1; y++)
                {
                    var selected = y == currentYear ? "selected" : "";
            }
            }
            @for (int y = currentYear - 3; y <= currentYear + 1; y++)
            {
                <option value="@y" selected="@(y == currentYear ? "selected" : null)">@y</option>
            }
          </select>
        </div>
        <div class="mb-3">
          <label for="monthSelect" class="form-label">Месяц</label>
          <select id="monthSelect" class="form-select">
            @{
                var months = System.Globalization.CultureInfo.GetCultureInfo("ru-RU").DateTimeFormat.MonthNames;
                int currentMonth = DateTime.Now.Month;
                for (int m = 1; m <= 12; m++)
                {
                    <option value="@m" selected="@(m == currentMonth ? "selected" : null)">@months[m-1]</option>
                }
            }
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="exportExcelBtn" class="btn btn-success">Отчёт <i class="bi bi-file-earmark-excel"></i></button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script src="~/js/operationsTable.js"></script>
    <script>
        document.getElementById('changesPerMonth').addEventListener('click', function () {
            var modal = new bootstrap.Modal(document.getElementById('monthModal'));
            modal.show();
        });

        document.getElementById('exportExcelBtn').addEventListener('click', function () {
            var year = document.getElementById('yearSelect').value;
            var month = document.getElementById('monthSelect').value;
            window.location.href = `/Operations/ExportMonthlyChangesRaw?year=${year}&month=${month}`;
            bootstrap.Modal.getInstance(document.getElementById('monthModal')).hide();
        });
    </script>
}

